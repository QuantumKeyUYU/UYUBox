#!/usr/bin/env python3
"""Scan project dependencies for known vulnerabilities using safety."""
from __future__ import annotations

import json
import subprocess
import sys
from pathlib import Path


REQ_FILE = Path("requirements.txt")


def main() -> None:
    if not REQ_FILE.exists():
        print("requirements.txt not found", file=sys.stderr)
        sys.exit(0)

    cmd = [
        "safety",
        "check",
        "--full-report",
        "--output",
        "json",
        "-r",
        str(REQ_FILE),
    ]
    result = subprocess.run(cmd, capture_output=True, text=True)
    output = result.stdout.strip()
    if output:
        try:
            data = json.loads(output)
        except json.JSONDecodeError:
            print(output)
            sys.exit(result.returncode)
    else:
        data = {}

    vulns = data.get("vulnerabilities", [])
    for v in vulns:
        sev = v.get("severity", "unknown")
        pkg = v.get("package_name")
        ver = v.get("affected_versions")
        adv = v.get("advisory", "")
        print(f"{pkg} {ver}: {sev}\n  {adv}\n")

    if any(v.get("severity", "").lower() in {"high", "critical"} for v in vulns):
        sys.exit(1)


if __name__ == "__main__":
    main()
