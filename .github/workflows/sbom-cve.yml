# .github/workflows/sbom-cve.yml
name: SBOM & CVE Scan

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

permissions:
  contents: read
  security-events: write

jobs:
  sbom-cve-scan:
    name: Generate SBOM and scan for vulnerabilities
    runs-on: ubuntu-latest

    steps:
      # ─────────────────────────────────────────────────────────────────────
      # Шаг 1. Checkout репозитория
      # ─────────────────────────────────────────────────────────────────────
      - name: Checkout repository
        uses: actions/checkout@v3

      # ─────────────────────────────────────────────────────────────────────
      # Шаг 2. Install Trivy
      # ─────────────────────────────────────────────────────────────────────
      - name: Install Trivy
        uses: aquasecurity/trivy-action@master

      # ─────────────────────────────────────────────────────────────────────
      # Шаг 3. Generate SBOM (CycloneDX-JSON)
      # ─────────────────────────────────────────────────────────────────────
      - name: Generate SBOM (CycloneDX)
        run: |
          # Генерируем SBOM в формате CycloneDX-JSON
          trivy sbom --format cyclonedx --output sbom.json .

      # ─────────────────────────────────────────────────────────────────────
      # Шаг 4. Scan SBOM for HIGH/CRITICAL vulnerabilities
      # ─────────────────────────────────────────────────────────────────────
      - name: Scan SBOM for HIGH/CRITICAL vulnerabilities
        run: |
          # Сканируем sbom.json на уязвимости категории HIGH и CRITICAL
          trivy sbom --format table --scanners vuln --severity HIGH,CRITICAL sbom.json

      # ─────────────────────────────────────────────────────────────────────
      # Шаг 5. Upload sbom.json как артефакт
      # ─────────────────────────────────────────────────────────────────────
      - name: Upload SBOM artifact
        uses: actions/upload-artifact@v3
        with:
          name: sbom-json
          path: sbom.json

      # ─────────────────────────────────────────────────────────────────────
      # Шаг 6. Generate Trivy JSON report (optional) и upload
      # ─────────────────────────────────────────────────────────────────────
      - name: Generate Trivy JSON report
        if: always()
        run: |
          # Генерируем JSON-отчёт о HIGH/CRITICAL уязвимостях
          trivy sbom \
            --format json \
            --scanners vuln \
            --severity HIGH,CRITICAL \
            sbom.json > trivy-report.json

      - name: Upload Trivy JSON report
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: trivy-report-json
          path: trivy-report.json
